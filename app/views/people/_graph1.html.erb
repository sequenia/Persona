<script type="text/javascript">
  var CoefConvRubyToJSDate = 1000;
  var SinusCalculateStep   = 1000000;
  var MaxDateStr           = '2064-01-01';
  var yearPeriod = 1;
  var monthPeriod = 14;

  var plot;
  var overview;
  var options;
  var data;
  
  var datasets = {};
  var datasetsOtherPerson = {};
  var yearDatasets = {};
  var monthDatasets = {};
  var yearDatasetsOtherPerson = {};
  var monthDatasetsOtherPerson = {};

  var choiceContainer;
  var choiceContainerOtherPerson;
  var otherPersons;

  var maxDate = Number(new Date(MaxDateStr)) / 1000;

  var birthYear;
  var birthYearOtherPerson;

  function rgbToHex(R,G,B) {return toHex(R)+toHex(G)+toHex(B)}

  function toHex(n) 
  {

      n = parseInt(n,10);
      if (isNaN(n)) return "00";
      n = Math.max(0,Math.min(n,255));
      return "0123456789ABCDEF".charAt((n-n%16)/16)
        + "0123456789ABCDEF".charAt(n%16);

  }

  var redColor   = "#" + rgbToHex(150, 0, 0);
  var greenColor = "#" + rgbToHex(0, 150, 0);
  var blueColor  = "#" + rgbToHex(0, 0, 150);
  var grayColor  = "#" + rgbToHex(150, 150, 150);

  function getRandomInt(min, max)
  {

      return Math.floor(Math.random() * (max - min + 1)) + min;

  }

  // Генерация точек синуса в промжутке с заданным смещением
  function genPointsToSinus(LeftEndPoint, RightEndPoint, Step, XCoeff, Offset, CoordZero)
  {
      var Points = [];

      for(var i = LeftEndPoint - CoordZero; i < RightEndPoint - CoordZero; i += Step)
      {

          Points.push([(i + CoordZero) * CoefConvRubyToJSDate, Math.sin(XCoeff * i - Offset)]);

      }

      return Points;
  }

  // Генерация точек на графике
  function genOtherPoints(BirthDate, MemoryDate1, MemoryDate2, EndPoint, Zero, T)
  {

      var CtrlPoints  = [];
      var MinusPoints = [];
      var PlusPoints  = []; 
      var ZeroPoints  = [];
      var counter = 0;
      var IsPositive = new Boolean(true);

      MinusPoints.push([BirthDate * CoefConvRubyToJSDate,   0]);
      ZeroPoints.push( [(BirthDate + (Zero - BirthDate) / 2) * CoefConvRubyToJSDate,   0]);
      CtrlPoints.push([MemoryDate1 * CoefConvRubyToJSDate, 0]);
      CtrlPoints.push([MemoryDate2 * CoefConvRubyToJSDate, 0]);

      for(var i = Zero; i <= EndPoint; i += T / 2)
      {

          if(i != MemoryDate1 && i != MemoryDate2)
          {

              if(counter % 2 == 0)
              {

                  if(IsPositive) PlusPoints.push([i * CoefConvRubyToJSDate, 0]);
                  else MinusPoints.push([i * CoefConvRubyToJSDate, 0]);
                  IsPositive = !IsPositive;

              }
              else
              {

                  ZeroPoints.push([i * CoefConvRubyToJSDate,   0]);

              }

          }

          counter++;

      }

      var AllPoints = 
      {
          "CtrlPoints"  : CtrlPoints,
          "MinusPoints" : MinusPoints,
          "PlusPoints"  : PlusPoints,
          "ZeroPoints"  : ZeroPoints
      }

      return AllPoints;
  }

  // Генерация хэша с точками для линии жизни

  function pointsToLife(Label, Data, Color)
  {

      return {

        label: Label,
        data: Data,
        color: Color

      };

  }

  // Генерация хэша с точками для синусов
  function pointsToGraph(Data, Color)
  {

      return { 
          data: Data,
          lines: { show: false },
          points: 
          { 
            show: true,
            radius: 3,
            lineWidth: 2, // in pixels
            fill: false,
            fillColor: Color,
            symbol: "circle" // or callback
          },
          color: Color
      };

  }

  // Создание графика линии жизни
  function lifeInit(BirthDate, EndPoint, personType)
  {

      var Graph  = {};
      var GraphPoints = [];
      var Points = [];

      var BDate  = new Date(BirthDate * CoefConvRubyToJSDate);
      var EndDate = new Date(EndPoint * CoefConvRubyToJSDate);
      var Multiply = (BDate.getDate() * 100 + (BDate.getMonth() + 1)) * BDate.getFullYear();
      var MultiplyStr = Multiply.toString();
      var counter = 0;
      var len = MultiplyStr.length;

      BDate = new Date(BDate.getFullYear(), 0, 1);

      while(BDate < EndDate)
      {

          GraphPoints.push([BDate.valueOf(), (MultiplyStr[counter].charCodeAt(0) - "0".charCodeAt(0)) / 4 + 2.5]);

          BDate = new Date(BDate.getFullYear() + 1, 0, 1);
          counter++;
          if(counter == len) counter = 0;

      }

      if(personType == 1)
      {
        Graph["Sinus"] = 
        {
            data: GraphPoints,
            lines: { show: false },
            points: { show: true },
            dashes: { show: true, dashLength: 5, lineWidth: 1 }
        };
      }
      else
      {
        Graph["Sinus"] = 
        {
            data: GraphPoints,
            lines: { show: true },
            points: { show: true },
            dashes: { show: false }
        };
      }

      Graph["CtrlPoints"] = {};
      Graph["Minus"] = {};
      Graph["Plus"] = {};
      Graph["Zero"] = {};

      return Graph;

  }

  function labelInit(personType)
  {

      var Graph  = {};
      var Points = [];

      Graph["Sinus"] = {};

      if(personType == 0)
      {

          Graph["CtrlPoints"] = pointsToLife("Точки, определившие период синусоиды", Points, greenColor);
          Graph["Minus"] = pointsToLife("Минусы", Points, redColor);
          Graph["Plus"] = pointsToLife("Плюсы", Points, blueColor);
          Graph["Zero"] = pointsToLife("Нули", Points, grayColor);

      }
      else 
      {
          Graph["CtrlPoints"] = {};
          Graph["Minus"] = {};
          Graph["Plus"] = {};
          Graph["Zero"] = {};
      }

      return Graph;

  }

  // Создание графика синуса
  function graphInit(BirthDate, MemoryDate1, MemoryDate2, EndPoint, period, personType)
  {

      sinusCalculateStep = SinusCalculateStep / period;
      var Graph = {};
      var Zero = MemoryDate1;
      var T    = (MemoryDate2 - MemoryDate1) / period;
      var XCoeff      = 2 * Math.PI / T;
      var GraphPoints = [];

      while(Zero - BirthDate > T * period)
      {

          Zero = Zero - T * period;

      }

      var PreXCoeff = period * 2 * Math.PI / (Zero - BirthDate);
      GraphPoints = GraphPoints.concat(
          genPointsToSinus(BirthDate, Zero, sinusCalculateStep, PreXCoeff, Math.PI, Zero),
          genPointsToSinus(Zero, EndPoint, sinusCalculateStep, XCoeff, Math.PI, Zero)
        );

      var OtherPoints = genOtherPoints(BirthDate, MemoryDate1, MemoryDate2, EndPoint, Zero, T);

      if(personType == 1)
      {
        Graph["Sinus"] = 
        {
            data: GraphPoints,
            lines: { show: false },
            points: { show: false },
            dashes: { show: true, dashLength: 5, lineWidth: 1 }
        };
      }
      else
      {
        Graph["Sinus"] = 
        {
            data: GraphPoints,
            lines: { show: true },
            points: { show: false },
            dashes: { show: false }
        };
      }

      Graph["CtrlPoints"] = pointsToGraph(OtherPoints["CtrlPoints"], greenColor);
      Graph["Minus"] = pointsToGraph(OtherPoints["MinusPoints"], redColor);
      Graph["Plus"] = pointsToGraph(OtherPoints["PlusPoints"], blueColor);
      Graph["Zero"] = pointsToGraph(OtherPoints["ZeroPoints"], grayColor);

      return Graph;

  }

  function getDate(DateWithSign)
  {

      return DateWithSign[0];

  }

  function getSign(DateWithSign)
  {

      return DateWithSign[1];

  }

  function setLines(dataSets, Graph, label)
  {

      dataSets[label] = 
      {
          "Sinus" : Graph["Sinus"],
          "Minus" : Graph["Minus"],
          "Zero"  : Graph["Zero"],
          "Plus"  : Graph["Plus"],
          "CtrlPoints" : Graph["CtrlPoints"]
      }

  }

  // Создать датасет для персоны с указанным периодом
  function createDatasets(BirthDate, MaxDate, Dates, period, personType)
  {

      var Datasets = {};

      setLines(Datasets, lifeInit(BirthDate, MaxDate, personType), "Дискретизация");
      setLines(Datasets, labelInit(personType), "Легенда");

      for(var i = 0; i < Dates.length - 1; i++)
      {

          for(var j = i + 1; j < Dates.length; j++)
          {

              if(getSign(Dates[i]) != getSign(Dates[j]))
              {

                  var Graph = graphInit(BirthDate, getDate(Dates[i]), getDate(Dates[j]), MaxDate, period, personType);
                  setLines(Datasets, Graph, (new Date(getDate(Dates[i]) * CoefConvRubyToJSDate)).toLocaleDateString() + 
                    ", " + (new Date(getDate(Dates[j]) * CoefConvRubyToJSDate)).toLocaleDateString());

              }

          }

      }

      return Datasets;

  }

  function pushToData(key)
  {
      data.push(datasets[key]["Sinus"]);
      data.push(datasets[key]["Minus"]);
      data.push(datasets[key]["Plus"]);
      data.push(datasets[key]["Zero"]);
      data.push(datasets[key]["CtrlPoints"]);

  }

  function upgradePlotByOtherPerson(otherPersonId)
  {
      <% Person.all.each do |per| %>
          if(<%= per.id %> == otherPersonId)
          {
              var dates = <%= per.get_dates_with_signs %>;
              var birthDate = <%= per.get_birth %>;
              birthYearOtherPerson = new Date((new Date(birthDate * CoefConvRubyToJSDate)).getFullYear(), 0, 1);
              

              yearDatasetsOtherPerson = createDatasets(birthDate, maxDate, dates, yearPeriod, 1);
              monthDatasetsOtherPerson = createDatasets(birthDate, maxDate, dates, monthPeriod, 1);
              $.each(yearDatasetsOtherPerson, function(key, val)
              { 
                  if(key != "Легенда")
                  {
                      var r = 0;
                      var g = 0;
                      var b = 0;
                      if(key != "Дискретизация")
                      {
                          r = getRandomInt(0, 255);
                          g = getRandomInt(0, 255);
                          b = getRandomInt(0, 255);
                      }
                      else
                      {
                          r = 0;
                          g = 0;
                          b = 0;
                      }

                      val["Sinus"].color = "#" + rgbToHex(r, g, b);
                      monthDatasetsOtherPerson[key]["Sinus"].color = val["Sinus"].color;

                  }
              });  
          }
      <% end %>
  }

  // Внесение изменений на страницу (Чекбоксы, радиокнопки)
  // А так же отрисовка графа после изменений
  function plotAccordingToChoices() 
  {

      var graphType = $('input[name=graphType]:checked').val();
      var otherPersonId = $('select[name=otherPersons]').val();

      if(otherPersonId == -1)
        birthYearOtherPerson = Number(new Date(MaxDateStr));

      upgradePlotByOtherPerson(otherPersonId);

      datasetsOtherPerson = {};

      if(graphType == 1)
      {

          datasets = yearDatasets;
          if(otherPersonId != -1)
          {
            datasetsOtherPerson = yearDatasetsOtherPerson;
          }

      }
      else
      {

          datasets = monthDatasets;
          if(otherPersonId != -1)
          {
            datasetsOtherPerson = monthDatasetsOtherPerson;
          }

      }

      data = [];

      choiceContainer.find("input:checked").each(function () 
      {

          var key = $(this).attr("name");
          if (key && datasets[key]) 
          {

              pushToData(key);

          }

      });

      $.each(datasetsOtherPerson, function(key, val)
      {
          data.push(datasetsOtherPerson[key]["Sinus"]);
          data.push(datasetsOtherPerson[key]["Minus"]);
          data.push(datasetsOtherPerson[key]["Plus"]);
          data.push(datasetsOtherPerson[key]["Zero"]);
          data.push(datasetsOtherPerson[key]["CtrlPoints"]);
      });

      pushToData("Легенда");

      options = 
      {
          lines: 
          {
              show: true,
              lineWidth: 1
          },
          yaxis:
          {
              show: true,
              panRange: [-1.5, 7],
              zoomRange: [1, 1],
              min: -1.5,
              max: 7,
              ticks: 
              [
                  [ 0, "" ], [ -1, ""], [1, ""], [2.5, "0"], 
                  [2.75, "1"], [3, "2"], [3.25, "3"], [3.5, "4"],
                  [3.75, "5"], [4, "6"], [4.25, "7"], [4.5, "8"],
                  [4.75, "9"]
              ]
          },
          xaxis: 
          {
              mode: "time",
              timeformat: "%d/%m/%Y",
              panRange: [Math.min(birthYear.valueOf(), birthYearOtherPerson.valueOf()), maxDate * CoefConvRubyToJSDate],
              position: 'bottom'
          },
          zoom: 
          {
              interactive: true
          },
          pan: 
          {
              interactive: true
          }
      };

      plot = $.plot("#placeholder", data, options);

  }


  $(function() {

    var htmlStr = "";

    personSelecter = $("#otherPersons");
    otherPersons = <%= raw @person.get_person_names %>;

    htmlStr += "<option value=" +  "-1" +  ">" + "Без второй персоны" + "</option>";

    for(var i = 0; i < otherPersons.length; i++)
    {

        htmlStr += "<option value=" +  otherPersons[i][0].toString() +  ">" + otherPersons[i][1] + "</option>";

    }

    personSelecter.append(htmlStr);

    var dates = <%= @person.get_dates_with_signs %>;
    var birthDate = <%= @person.get_birth %>;
    birthYear = new Date((new Date(birthDate * CoefConvRubyToJSDate)).getFullYear(), 0, 1);
    

    yearDatasets = createDatasets(birthDate, maxDate, dates, yearPeriod, 0);
    monthDatasets = createDatasets(birthDate, maxDate, dates, monthPeriod, 0);

    choiceContainer = $("#choicestable");
    
    htmlStr = "";
    htmlStr += "<thead>";
    htmlStr += "<tr><th>Показать</th><th>Цвет</th><th>Подпись</th></tr>";
    htmlStr += "</thead>";

    $.each(yearDatasets, function(key, val)
    { 
        if(key != "Легенда")
        {
            var r = 0;
            var g = 0;
            var b = 0;
            if(key != "Дискретизация")
            {
                r = getRandomInt(0, 255);
                g = getRandomInt(0, 255);
                b = getRandomInt(0, 255);
            }
            else
            {
                r = 0;
                g = 0;
                b = 0;
            }

            val["Sinus"].color = "#" + rgbToHex(r, g, b);
            monthDatasets[key]["Sinus"].color = val["Sinus"].color;

            htmlStr += "<tr>";

            htmlStr += 
            "<td>" +
                "<input type='checkbox' name='" + key + "' checked='checked' id='id" + key + "'></input>" +
            "</td>" + 
            "<td>" +
                "<div style='width:14px; border:1px solid #ccc;padding:1px'>" + 
                  "<div style='width:4px;height:0;border:5px solid rgb(" + 
                  Math.floor(r).toString() + "," + 
                  Math.floor(g).toString() + "," + 
                  Math.floor(b).toString() +  
                  ");overflow:hidden'></div>" +
                "</div>" + 
            "</td>" +
            "<td>" +
                key +
            "</td>";

            htmlStr += "</tr>";
        }
    });  

    choiceContainer.append(htmlStr); 

    choiceContainer.find("input").click(plotAccordingToChoices);

    plotAccordingToChoices();

  });

 </script>

<p id="peopleselect" class= "peopleselecter"></p>

<div id="content">

    Вторая персона:<br/>
    <select name="otherPersons" id="otherPersons" onchange="plotAccordingToChoices()">
    </select>
    <br/>

    <input id = "graphType1" type="radio" name="graphType" value=1 onClick="plotAccordingToChoices()" checked> Годовой график <br>
    <input id = "graphType2" type="radio" name="graphType" value=2 onClick="plotAccordingToChoices()"> Месячный график <br>

    <div class="demo-container">
      <div id="placeholder" class="demo-placeholder" style="float:left; width:850px; height: 460px;"></div>
      <p id="choices" style="float:right; width:280px;">
        <table id="choicestable" class= "legendtable">
        </table>
      </p>
    </div>

</div>